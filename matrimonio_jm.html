<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Planificador Matrimonio Civil - Jesús María</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f6f9; color: #333; }
    header { background: #2b6cb0; color: white; padding: 12px; text-align: center; }
    h1 { margin: 0; font-size: 20px; }
    .tabs { display: flex; background: #edf2f7; border-bottom: 2px solid #ccc; }
    .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; font-weight: bold; }
    .tab.active { background: #2b6cb0; color: white; }
    .content { display: none; padding: 16px; }
    .content.active { display: block; }
    .task { display: flex; align-items: center; margin-bottom: 8px; }
    .task select, .task textarea { margin-left: 8px; }
    .progress-bar { background: #e2e8f0; border-radius: 8px; overflow: hidden; height: 18px; margin: 10px 0; }
    .progress-fill { background: #2b6cb0; height: 100%; text-align: right; color: white; padding-right: 4px; font-size: 12px; }
    .alert { color: red; font-size: 14px; }
    .budget-item { display: flex; gap: 8px; margin-bottom: 6px; }
    .budget-item input { flex: 1; padding: 4px; }
    button { background: #2b6cb0; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; }
    button.ghost { background: #e2e8f0; color: #333; }
    footer { font-size: 12px; color: gray; padding: 12px; text-align: center; }
  </style>
</head>
<body>
<header>
  <h1>📋 Planificador Matrimonio Civil — Jesús María</h1>
</header>

<div class="tabs">
  <div class="tab active" data-tab="req">Requisitos</div>
  <div class="tab" data-tab="exp">Expediente</div>
  <div class="tab" data-tab="res">Reserva</div>
  <div class="tab" data-tab="pres">Presupuesto</div>
</div>

<!-- Requisitos -->
<div id="req" class="content active">
  <h2>1. Requisitos previos</h2>
  <div id="reqTasks"></div>
  <div class="progress-bar"><div id="reqProgress" class="progress-fill">0%</div></div>
</div>

<!-- Expediente -->
<div id="exp" class="content">
  <h2>2. Expediente matrimonial</h2>
  <div id="expTasks"></div>
  <div class="progress-bar"><div id="expProgress" class="progress-fill">0%</div></div>
</div>

<!-- Reserva -->
<div id="res" class="content">
  <h2>3. Reserva y fechas</h2>
  <label>📅 Publicación del Edicto: <input type="date" id="edictDate"></label><br><br>
  <label>📅 Certificado médico: <input type="date" id="certDate"></label><br><br>
  <label>📅 Fecha de ceremonia: <input type="date" id="ceremonyDate"></label>
  <div id="alerts"></div>
  <hr>
  <div id="resTasks"></div>
  <div class="progress-bar"><div id="resProgress" class="progress-fill">0%</div></div>
</div>

<!-- Presupuesto -->
<div id="pres" class="content">
  <h2>4. Presupuesto</h2>
  <div id="budgetList"></div>
  <button id="addExpense">➕ Agregar gasto</button>
  <h3>Total: S/ <span id="totalBudget">0.00</span></h3>
</div>

<!-- Export/Import -->
<div style="padding:16px">
  <button id="exportBtn">💾 Exportar</button>
  <input type="file" id="importFile" style="display:none">
  <button class="ghost" onclick="document.getElementById('importFile').click()">📂 Importar</button>
  <button class="ghost" id="resetBtn">🔄 Restablecer</button>
</div>

<footer>
  Todos los datos se guardan en tu navegador. Usa Exportar/Importar para respaldo.
</footer>

<script>
const STORAGE_KEY = "jm-checklist-v2";

let state = {
  tasks: {
    req: [
      "Residencia acreditada en DNI",
      "Solicitud - Declaración Jurada firmada",
      "Certificado médico (vigencia 30 días)",
      "Dos testigos con DNI vigente",
      "Documentos adicionales (partidas, dispensa)"
    ],
    exp: [
      "Presentar expediente completo en Municipalidad",
      "Publicación del Edicto (8 días)",
      "Dispensa del Edicto (si aplica)",
      "Control del plazo (4 meses)"
    ],
    res: [
      "Reservar fecha tras los 8 días del edicto",
      "Confirmar horario disponible (10:00–16:00)",
      "Llegar 15 min antes (tolerancia 15 min)"
    ]
  },
  status: {}, // estado de cada tarea
  notes: {},  // notas de cada tarea
  dates: { edict:null, cert:null, ceremony:null },
  budget: []
};

// Cargar desde localStorage
function load() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if(saved) state = JSON.parse(saved);
}
function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

// Render tareas
function renderTasks(section) {
  const root = document.getElementById(section+"Tasks");
  root.innerHTML = "";
  state.tasks[section].forEach((t,i)=>{
    const id = section+"-"+i;
    const status = state.status[id] || "pendiente";
    const note = state.notes[id] || "";
    root.innerHTML += `
      <div class="task">
        <span>✔️</span>
        <select data-id="${id}">
          <option ${status=="pendiente"?"selected":""}>pendiente</option>
          <option ${status=="en proceso"?"selected":""}>en proceso</option>
          <option ${status=="completo"?"selected":""}>completo</option>
        </select>
        <span style="flex:1;margin-left:8px">${t}</span>
      </div>
      <textarea data-note="${id}" placeholder="Notas...">${note}</textarea>
    `;
  });
  // Listeners
  root.querySelectorAll("select").forEach(sel=>{
    sel.addEventListener("change",e=>{
      state.status[e.target.dataset.id] = e.target.value;
      save(); updateProgress();
    });
  });
  root.querySelectorAll("textarea").forEach(ta=>{
    ta.addEventListener("input",e=>{
      state.notes[e.target.dataset.note] = e.target.value;
      save();
    });
  });
}

// Progreso
function updateProgress() {
  ["req","exp","res"].forEach(sec=>{
    const total = state.tasks[sec].length;
    let done = 0;
    state.tasks[sec].forEach((_,i)=>{
      if(state.status[sec+"-"+i]=="completo") done++;
    });
    const pct = Math.round((done/total)*100);
    document.getElementById(sec+"Progress").style.width = pct+"%";
    document.getElementById(sec+"Progress").innerText = pct+"%";
  });
}

// Presupuesto
function renderBudget() {
  const root = document.getElementById("budgetList");
  root.innerHTML = "";
  state.budget.forEach((b,i)=>{
    root.innerHTML += `
      <div class="budget-item">
        <input type="text" data-concept="${i}" value="${b.concept}">
        <input type="number" step="0.01" data-amount="${i}" value="${b.amount}">
        <button data-del="${i}">🗑</button>
      </div>
    `;
  });
  let total = state.budget.reduce((a,b)=>a+Number(b.amount||0),0);
  document.getElementById("totalBudget").innerText = total.toFixed(2);

  root.querySelectorAll("input[data-concept]").forEach(inp=>{
    inp.oninput = e=>{
      state.budget[e.target.dataset.concept].concept = e.target.value;
      save();
    };
  });
  root.querySelectorAll("input[data-amount]").forEach(inp=>{
    inp.oninput = e=>{
      state.budget[e.target.dataset.amount].amount = parseFloat(e.target.value||0);
      save(); renderBudget();
    };
  });
  root.querySelectorAll("button[data-del]").forEach(btn=>{
    btn.onclick = e=>{
      state.budget.splice(e.target.dataset.del,1);
      save(); renderBudget();
    };
  });
}

// Fechas y alertas
function checkDates() {
  const {edict,cert,ceremony} = state.dates;
  let msg = "";
  if(edict){
    let edEnd = new Date(edict); edEnd.setDate(edEnd.getDate()+8);
    msg += `✔ Edicto finaliza: ${edEnd.toLocaleDateString()}<br>`;
  }
  if(cert){
    let certEnd = new Date(cert); certEnd.setDate(certEnd.getDate()+30);
    if(ceremony && new Date(ceremony)>certEnd) msg += `<span class="alert">⚠ Certificado vencido antes de la ceremonia</span><br>`;
  }
  document.getElementById("alerts").innerHTML = msg;
}

// Eventos de fechas
["edictDate","certDate","ceremonyDate"].forEach(id=>{
  document.getElementById(id).onchange = e=>{
    state.dates[id.replace("Date","")] = e.target.value;
    save(); checkDates();
  };
});

// Exportar / Importar
document.getElementById("exportBtn").onclick = ()=>{
  const blob = new Blob([JSON.stringify(state)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "matrimonio.json"; a.click();
};
document.getElementById("importFile").onchange = e=>{
  const file = e.target.files[0];
  if(!file) return;
  const r = new FileReader();
  r.onload = ()=>{ state = JSON.parse(r.result); save(); init(); };
  r.readAsText(file);
};
document.getElementById("resetBtn").onclick = ()=>{
  if(confirm("¿Seguro quieres borrar todo?")){
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }
};

// Tabs
document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick = ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".content").forEach(c=>c.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");
  };
});

// Inicializar
function init(){
  renderTasks("req");
  renderTasks("exp");
  renderTasks("res");
  updateProgress();
  renderBudget();
  checkDates();
  document.getElementById("addExpense").onclick = ()=>{
    state.budget.push({concept:"",amount:0});
    save(); renderBudget();
  };
  document.getElementById("edictDate").value = state.dates.edict || "";
  document.getElementById("certDate").value = state.dates.cert || "";
  document.getElementById("ceremonyDate").value = state.dates.ceremony || "";
}
load();
init();
</script>
</body>
</html>
